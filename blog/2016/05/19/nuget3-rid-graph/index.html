<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>NuGet 3: The Runtime ID Graph</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Infrequent blog posts about software development, lifehacks, opinion, etc.
">
    <meta name="generator" content="Jekyll">
    <meta name="author" content="Nate McMaster" comment="Surprised?">
    <meta http-equiv="Content-Language" content="en">
    <link rel="canonical" href="http://www.natemcmaster.com/blog/2016/05/19/nuget3-rid-graph/">
    <link href="http://fonts.googleapis.com/css?family=Source+Code+Pro|Roboto+Slab:400,300|Open+Sans:300italic,400italic,600italic,400,600,300" rel="stylesheet" type="text/css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="/assets/ga-d1faeb94eb25224ec0843d6c613d8cde7f294fd1d5bddd72fd16bbf8cccfe517.js"></script>
    <script type="text/javascript">
        (function (ga) {
            ga('send', 'pageview');
        })(ga);
    </script>
    <link type="text/css" rel="stylesheet" href="/assets/app-7b60898ffb432402cbfb18ab2e139a875cf186b57622c8094976512a22f630d8.css">
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <nav class="site-nav">
      <a href="#" class="menu-icon" analytics-on="click" analytics-event="menu_button">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" xml:space="preserve">
          <path fill="white" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="white" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="white" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link " href="/blog/">
          Blog
          </a>
        
        
          <a class="page-link " href="/projects/">
          Projects
          </a>
        
        
          
        
          <a class="page-link " href="/profile/">
          About Me
          </a>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>
    <div class="brand">
      <div class="brand-img">
        <a href="/">
          <img src="//www.gravatar.com/avatar/692c58f37a3704944bd31c4cbcb287e7.png?s=150" class="img-profile"></a>
      </div>
      <div class="brand-name">
        <a class="site-title" href="/">Nate McMaster</a>
      </div>
    </div>
  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <header class="post-header">
  <p class="meta">Blog Post: May 19, 2016</p>
  <h1>NuGet 3: The Runtime ID Graph</h1>
  
</header>

<article class="post-content">
  
<p>If you have ever cracked open* a NuGet package such as .NET Core’s 
<a href="https://www.nuget.org/packages/System.IO.Compression/">System.IO.Compression</a>,
you have may have noticed that the package includes a folder named “runtimes”.
What is the folder and how is it used?</p>

<p>*It’s just a zip file. Unzip it.</p>

<p>###TLDR;</p>

<p>Here is the RC2 rid graph:
<a href="https://github.com/dotnet/corefx/blob/v1.0.0-rc2/pkg/Microsoft.NETCore.Platforms/runtime.json">https://github.com/dotnet/corefx/blob/v1.0.0-rc2/pkg/Microsoft.NETCore.Platforms/runtime.json</a></p>

<h2 id="background">Background</h2>

<p>NuGet’s official documentation only comments on runtimes briefly. 
See <a href="https://docs.nuget.org/consume/projectjson-format#runtimes">https://docs.nuget.org/consume/projectjson-format#runtimes</a>. The documentation
doesn’t detail how runtimes work in NuGet 3 under the hood. In this post, I’ll share
some of the internal workings of NuGet 3 and “runtimes”.</p>

<h2 id="what-are-runtimes">What are “runtimes”?</h2>

<p>In NuGet, “runtimes” is essential synonymous with “operating systems”. Don’t confuse
this with how .NET uses the word (e.g. the .NET runtime != NuGet runtimes.)</p>

<p>The .NET Core docs page also include an explanation of this.
<a href="http://dotnet.github.io/docs/core-concepts/rid-catalog.html">http://dotnet.github.io/docs/core-concepts/rid-catalog.html</a></p>

<h2 id="what-is-a-rid">What is a RID?</h2>
<p>Runtime identifier, or the specific moniker for a specific runtime. It usually includes name, version, and bitness.</p>

<p>Example: “win10-x64” is the RID for “Windows 10, 64bit”.</p>

<p>Example 2: “win10-x64-aot” is the RID used specially for Universal Windows Platform apps
that have been compiled with .NET Native. AOT = Ahead Of Time. All UWP apps are compiled
with the .NET Native compiler before being published to the Windows Store. This special
RID was included to accommodate special changes to .NET Core itself to make it compatible
with .NET Native apps.</p>

<h2 id="what-goes-in-the-runtimes-folder">What goes in the “runtimes” folder?</h2>

<p>The runtimes folder is for operating-system specific libraries. Sometimes it is not possible
to write code that works on all operating systems. For example,
System.IO.Compression includes a library design for *nix systems and another for Windows systems.</p>

<p>Managed libraries can be placed in folders that follow this pattern.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>runtimes/{rid}/lib/{tfm}/*.dll
</code></pre>
</div>

<p>Native libraries (*.dll on Windows, *.so for Linux, *.dylib for OSX) can be included as well.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>runtimes/{rid}/native/*.(dll | so | dylib )
</code></pre>
</div>

<p>*“tfm” refers to “target framework moniker”. See <a href="https://docs.nuget.org/create/targetframeworks">https://docs.nuget.org/create/targetframeworks</a> for a
list of available TFMs and to determine which you should use.</p>

<h2 id="what-runtimes-are-available-for-nuget-3">What “runtimes” are available for NuGet 3?</h2>
<p>There is no set list of “runtimes”. This list is actually generated dynamically when you restore packages.
In most cases, this list of runtimes will come from a special package called 
<a href="https://www.nuget.org/packages?q=microsoft.netcore.platforms">“Microsoft.NETCore.Platforms”</a>.</p>

<p>This package contains a special file named “runtime.json” which lists dozens of “runtimes”. Here are just a few:</p>

<ul>
  <li>“fedora.23-x64”</li>
  <li>“win7-x86”</li>
  <li>“linuxmint.17.3”</li>
  <li>“ubuntu.15.04-x64”</li>
</ul>

<h2 id="what-is-the-rid-graph">What is the RID graph?</h2>

<p>The RID graph is a list of “runtimes” that are compatible with each other. For example, in theory
a library that is compatible with Windows 7 should also be compatible with newer version.</p>

<p>NuGet can import compatible libraries using something called the “RID graph” or “runtime fallback graph”. 
This is basically a list of all RIDs .NET Core supports, and which RIDs are compatible with each other.
The graph definition can be found in the <a href="https://github.com/dotnet/corefx/">https://github.com/dotnet/corefx/</a> repo. 
The RC2 graph is found in this file:</p>

<p><a href="https://github.com/dotnet/corefx/blob/v1.0.0-rc2/pkg/Microsoft.NETCore.Platforms/runtime.json">https://github.com/dotnet/corefx/blob/v1.0.0-rc2/pkg/Microsoft.NETCore.Platforms/runtime.json</a></p>

<p>Here is a snippet from that RID graph:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nt">"runtimes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"base"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="p">},</span><span class="w">

        </span><span class="nt">"any"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"base"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">

        </span><span class="nt">"win"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"any"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"win-x86"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"win"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"win-x64"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"win"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">

        </span><span class="nt">"win7"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"win"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"win7-x86"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"win7"</span><span class="p">,</span><span class="w"> </span><span class="s2">"win-x86"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"win7-x64"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"#import"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"win7"</span><span class="p">,</span><span class="w"> </span><span class="s2">"win-x64"</span><span class="w"> </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="how-is-the-rid-graph-used">How is the RID graph used?</h2>

<p>NuGet will use the graph to identify what “runtimes” and libraries are compatible. If there are runtimes
present in a package, but none with a package that match the exact runtime currently being used,
it will trace the graph back to the closest compatible system. For example, the list of RID fallbacks
for Windows 7 32 bit machines are as follows:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">win7-x86
win7
win-x86
win
any
base</code></pre></figure>

<p>For example, if I use a library that has a library under <code class="highlighter-rouge">runtimes/win/lib/*.dll</code> and I restore packages for 
Windows 7, 32 bit, NuGet can trace the RID graph and will fallback to the closest, most compatible RID,
 which in this case will be “win”.</p>

<h2 id="what-if-my-library-breaks-on-newer-operating-systems">What if my library breaks on newer operating systems?</h2>

<p>For example, what if a library that works for Windows 7 doesn’t work for Windows 10?</p>

<p>The NuGet solution for this is to also include a library under the Windows 10 RID. This will override
the Windows 7 library. NuGet only brings in the closest matching, compatible RID.</p>


</article>
<div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nmblog8'; // required: replace example with your forum shortname
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

  <div class="vcard">
    <h4 class="fn">Nate McMaster</h4>
  </div>

    <div class="footer-col-1 column">
      <div>
        <a href="mailto:" analytics-on="click" analytics-event="email" rel=""></a>
      </div>
      <div class="footer-icons">
          
            <a href="https://github.com/natemcmaster" analytics-on="click" analytics-event="outbound" analytics-label="github_profile">
              <span class="icon-github"></span>
            </a>
          
            <a href="https://twitter.com/natemcmaster" analytics-on="click" analytics-event="outbound" analytics-label="twitter_profile">
              <span class="icon-twitter"></span>
            </a>
          
           <a href="https://www.linkedin.com/in/natemcmaster" analytics-on="click" analytics-event="outbound" analytics-label="linkedin_profile">
            <span class="icon-linkedin"></span>
            </a>
          
      </div>
    </div>


    <div class="footer-col-3 column">
      <p class="text">Infrequent blog posts about software development, lifehacks, opinion, etc.
Disclaimer: Thoughts and opinions are my own.</p>
    </div>

  </div>

</footer>


    </body>
</html>
